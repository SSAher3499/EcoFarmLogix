// Prisma Schema for EcoFarmLogix
// Smart Polyhouse & Farm Remote Monitoring System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  fullName      String    @map("full_name")
  phone         String?
  role          UserRole  @default(FARM_OWNER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdById   String?   @map("created_by_id")

  // Relations
  createdBy     User?     @relation("UserCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdUsers  User[]    @relation("UserCreatedBy")
  ownedFarms    Farm[]    @relation("FarmOwner")
  farmAccess    FarmUser[]
  actionLogs    ActionLog[]
  refreshTokens RefreshToken[]
  schedules     Schedule[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

enum UserRole {
  SUPER_ADMIN
  FARM_OWNER
  MANAGER
  OPERATOR
  VIEWER
}

// ==========================================
// FARM USER ACCESS (Many-to-Many)
// ==========================================

model FarmUser {
  id          String       @id @default(uuid())
  farmId      String       @map("farm_id")
  userId      String       @map("user_id")
  role        FarmUserRole @default(VIEWER)
  isActive    Boolean      @default(true) @map("is_active")
  invitedById String?      @map("invited_by_id")
  invitedAt   DateTime     @default(now()) @map("invited_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  farm      Farm  @relation(fields: [farmId], references: [id], onDelete: Cascade)
  user      User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([farmId, userId])
  @@map("farm_users")
}

enum FarmUserRole {
  OWNER
  MANAGER
  OPERATOR
  VIEWER
}

// ==========================================
// FARM MANAGEMENT
// ==========================================

model Farm {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  name            String
  locationAddress String?   @map("location_address")
  latitude        Decimal?  @db.Decimal(10, 8)
  longitude       Decimal?  @db.Decimal(11, 8)
  areaSqft        Decimal?  @map("area_sqft") @db.Decimal(10, 2)
  farmType        FarmType  @default(POLYHOUSE) @map("farm_type")
  timezone        String    @default("Asia/Kolkata")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  owner           User              @relation("FarmOwner", fields: [userId], references: [id], onDelete: Cascade)
  farmUsers       FarmUser[]
  devices         Device[]
  alertRules      AlertRule[]
  alerts          Alert[]
  automationRules AutomationRule[]
  actionLogs      ActionLog[]
  schedules       Schedule[]

  @@map("farms")
}

enum FarmType {
  POLYHOUSE
  GREENHOUSE
  OPENFIELD
  SHADENET
  INDOOR
}

// ==========================================
// DEVICE MANAGEMENT
// ==========================================

model Device {
  id              String        @id @default(uuid())
  farmId          String        @map("farm_id")
  macAddress      String        @unique @map("mac_address")
  deviceName      String        @map("device_name")
  deviceType      DeviceType    @map("device_type")
  firmwareVersion String?       @map("firmware_version")
  isOnline        Boolean       @default(false) @map("is_online")
  lastSeenAt      DateTime?     @map("last_seen_at")
  ipAddress       String?       @map("ip_address")
  config          Json?         @default("{}")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  farm         Farm          @relation(fields: [farmId], references: [id], onDelete: Cascade)
  sensors      Sensor[]
  actuators    Actuator[]
  serialConfig SerialConfig?

  @@map("devices")
}

enum DeviceType {
  GATEWAY
  SENSOR_NODE
  RELAY_NODE
  CAMERA
  RASPBERRY_PI
}

// ==========================================
// SERIAL PORT CONFIGURATION (per device)
// ==========================================

model SerialConfig {
  id            String   @id @default(uuid())
  deviceId      String   @unique @map("device_id")
  
  // Serial Port Settings
  portName      String   @default("/dev/ttyUSB0") @map("port_name")
  baudRate      Int      @default(9600) @map("baud_rate")
  dataBits      Int      @default(8) @map("data_bits")
  parity        String   @default("none")
  stopBits      Int      @default(1) @map("stop_bits")
  
  // Modbus Settings
  timeout       Int      @default(1000)
  retries       Int      @default(3)
  pollInterval  Int      @default(5000) @map("poll_interval")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  device        Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("serial_configs")
}

// ==========================================
// SENSOR MANAGEMENT
// ==========================================

model Sensor {
  id                String     @id @default(uuid())
  deviceId          String     @map("device_id")
  sensorType        SensorType @map("sensor_type")
  sensorName        String     @map("sensor_name")
  unit              String
  
  // Connection Type
  connectionType    String     @default("GPIO") @map("connection_type")  // GPIO, MODBUS_RTU, MODBUS_TCP, ANALOG, I2C
  
  // Modbus Configuration
  slaveId           Int?       @map("slave_id")           // Modbus slave address (1-247)
  functionCode      Int?       @map("function_code")      // 1, 2, 3, 4
  registerAddress   Int?       @map("register_address")   // Starting register address
  registerCount     Int?       @default(1) @map("register_count")  // Number of registers to read
  dataType          String?    @default("INT16") @map("data_type") // INT16, UINT16, INT32, UINT32, FLOAT32
  byteOrder         String?    @default("AB") @map("byte_order")   // AB, BA, ABCD, DCBA, CDAB, BADC
  scaleFactor       Decimal?   @default(1) @map("scale_factor") @db.Decimal(10, 6)
  decimalPlaces     Int?       @default(1) @map("decimal_places")
  offset            Decimal?   @default(0) @db.Decimal(10, 4)
  
  // Thresholds & Calibration
  minThreshold      Decimal?   @map("min_threshold") @db.Decimal(10, 2)
  maxThreshold      Decimal?   @map("max_threshold") @db.Decimal(10, 2)
  calibrationOffset Decimal    @default(0) @map("calibration_offset") @db.Decimal(10, 4)
  readingInterval   Int        @default(60) @map("reading_interval")
  
  // Current State
  isActive          Boolean    @default(true) @map("is_active")
  lastReading       Decimal?   @map("last_reading") @db.Decimal(10, 2)
  lastReadingAt     DateTime?  @map("last_reading_at")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  // Relations
  device     Device      @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  alertRules AlertRule[]

  @@map("sensors")
}

enum SensorType {
  TEMPERATURE
  HUMIDITY
  SOIL_MOISTURE
  SOIL_TEMPERATURE
  LIGHT
  CO2
  PH
  EC
  WATER_FLOW
  WATER_LEVEL
  RAIN
  WIND_SPEED
  PRESSURE
}

// ==========================================
// ACTUATOR MANAGEMENT
// ==========================================

model Actuator {
  id           String       @id @default(uuid())
  deviceId     String       @map("device_id")
  actuatorType ActuatorType @map("actuator_type")
  actuatorName String       @map("actuator_name")
  gpioPin      Int?         @map("gpio_pin")
  
  // Modbus Configuration for Actuators
  connectionType   String    @default("GPIO") @map("connection_type")  // GPIO, MODBUS_RTU
  slaveId          Int?      @map("slave_id")
  registerAddress  Int?      @map("register_address")
  
  isActive     Boolean      @default(true) @map("is_active")
  currentState String       @default("OFF") @map("current_state")
  lastActionAt DateTime?    @map("last_action_at")
  config       Json?        @default("{}")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  device          Device           @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  actionLogs      ActionLog[]
  automationRules AutomationRule[]
  schedules       Schedule[]

  @@map("actuators")
}

enum ActuatorType {
  FAN
  EXHAUST_FAN
  FOGGER
  IRRIGATION_VALVE
  SHADE_NET
  GROW_LIGHT
  HEATER
  COOLER
  DOSING_PUMP
  WATER_PUMP
  RELAY
}

// ==========================================
// ALERTS & AUTOMATION
// ==========================================

model AlertRule {
  id              String        @id @default(uuid())
  farmId          String        @map("farm_id")
  sensorId        String        @map("sensor_id")
  name            String
  condition       AlertCondition
  thresholdValue  Decimal       @map("threshold_value") @db.Decimal(10, 2)
  alertType       AlertType     @map("alert_type")
  isEnabled       Boolean       @default(true) @map("is_enabled")
  cooldownMinutes Int           @default(30) @map("cooldown_minutes")
  lastTriggeredAt DateTime?     @map("last_triggered_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  farm   Farm   @relation(fields: [farmId], references: [id], onDelete: Cascade)
  sensor Sensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  @@map("alert_rules")
}

model Alert {
  id         String      @id @default(uuid())
  farmId     String      @map("farm_id")
  alertType  String      @map("alert_type")
  severity   AlertSeverity
  title      String
  message    String
  sensorData Json?       @map("sensor_data")
  isRead     Boolean     @default(false) @map("is_read")
  readAt     DateTime?   @map("read_at")
  createdAt  DateTime    @default(now()) @map("created_at")

  // Relations
  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@map("alerts")
}

enum AlertCondition {
  GREATER_THAN
  LESS_THAN
  EQUAL_TO
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
}

enum AlertType {
  EMAIL
  SMS
  PUSH
  WEBHOOK
  IN_APP
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

model AutomationRule {
  id            String          @id @default(uuid())
  farmId        String          @map("farm_id")
  actuatorId    String          @map("actuator_id")
  name          String
  triggerType   TriggerType     @map("trigger_type")
  triggerConfig Json            @map("trigger_config")
  actionConfig  Json            @map("action_config")
  isEnabled     Boolean         @default(true) @map("is_enabled")
  lastRunAt     DateTime?       @map("last_run_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  farm     Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  actuator Actuator @relation(fields: [actuatorId], references: [id], onDelete: Cascade)

  @@map("automation_rules")
}

enum TriggerType {
  SENSOR_VALUE
  SCHEDULE
  TIME_RANGE
  MANUAL
}

// ==========================================
// ACTION LOGS
// ==========================================

model ActionLog {
  id         String   @id @default(uuid())
  farmId     String   @map("farm_id")
  actuatorId String   @map("actuator_id")
  userId     String?  @map("user_id")
  action     String
  value      String?
  source     ActionSource
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  farm     Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  actuator Actuator  @relation(fields: [actuatorId], references: [id], onDelete: Cascade)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("action_logs")
}

enum ActionSource {
  MANUAL
  AUTOMATION
  SCHEDULE
  SYSTEM
  DEVICE
}

// ==========================================
// SCHEDULE MANAGEMENT
// ==========================================

model Schedule {
  id            String       @id @default(uuid())
  farmId        String       @map("farm_id")
  actuatorId    String       @map("actuator_id")
  name          String
  description   String?

  // Schedule Configuration
  scheduleType  ScheduleType @default(DAILY) @map("schedule_type")
  time          String       // Format: "HH:MM" (24-hour)
  daysOfWeek    Int[]        @default([0,1,2,3,4,5,6]) @map("days_of_week") // 0=Sunday, 6=Saturday

  // Action
  action        String       // "ON" or "OFF"
  duration      Int?         // Optional: auto turn off after X minutes

  // Status
  isEnabled     Boolean      @default(true) @map("is_enabled")
  lastRunAt     DateTime?    @map("last_run_at")
  nextRunAt     DateTime?    @map("next_run_at")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  createdById   String       @map("created_by_id")

  // Relations
  farm          Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  actuator      Actuator     @relation(fields: [actuatorId], references: [id], onDelete: Cascade)
  createdBy     User         @relation(fields: [createdById], references: [id])

  @@map("schedules")
}

enum ScheduleType {
  ONCE
  DAILY
  WEEKLY
  CUSTOM
}